 #!/usr/bin/env bash
# TODO: move to make or meson
# C11 standard
CSTD=c11
# Basic CFLAGS
CFLAGS="-Wall -Wextra -Werror -pedantic -Iinclude -I/usr/include"
LIBKTKFLAGS = "target/libktk.o -Ltarget/raylib/raylib/ -l:libraylib.a -lX11 -lxcb -lm -lpthread -ldl -lrt"
RUSTC=rustc
RUSTFLAGS=

setup_builddir() {
	mkdir -p target 
	mkdir -p target/tests
	git submodule update --init --recursive
}

build_extern_deps() {
	mkdir -p target/raylib
	cd target/raylib
	cmake ../../lib/extern/raylib
	make -j8
	cp raylib/include/r* ../../include 
	cd ../..
}

build_libktk() {
	echo "CC	lib/libktk/ktk.c"
	cc $CFLAGS -std=$CSTD -c lib/libktk/ktk.c -o target/libktk.o
}

build_libsysk() {
	echo "CC	NULL"
}

build_libkinet() {
	$RUSTC lib/libkinet/lib.rs --crate-type=cdylib -o target/libkinet.so
	echo "RUSTC	lib/libinet/lib.rs"
}

build_ktk_test() {
	echo "CC	lib/libktk/tests/sample.c"
	cc $CFLAGS -std=$CSTD -c lib/libktk/tests/sample.c -o target/tests/ktk_sample.o
}

build_libkinet_test() {
	cc $CFLAGS -std=$CSTD lib/libkinet/test.c -o target/kinet_test.out -L. -l:target/libkinet.so 
	echo "CC	lib/libkinet/test.c"
}

# binaries are named with k_$util for obvious reasons 
build_cu() {
	$RUSTC bin/cat/cat.rs -o target/k_cat
	echo "RUSTC	bin/cat/cat.rs"
	cc $CFLAGS -std=$CSTD bin/date/date.c -o target/k_date
	echo "CC	bin/date/date.c"
	cc $CFLAGS -std=$CSTD bin/uname/uname.c -o target/k_uname
	echo "CC	bin/uname/uname.c"
	cc $CFLAGS -std=$CSTD bin/true/true.c -o target/k_true
	echo "CC 	bin/true/true.c"
	cc $CFLAGS -std=$CSTD bin/tty/tty.c -o target/k_tty
	echo "CC 	bin/tty/tty.c"
	cc $CFLAGS -std=$CSTD bin/whoami/whoami.c -o target/k_whoami
}

setup_builddir
build_extern_deps
build_libktk
build_libsysk
build_libkinet 
build_ktk_test
build_libkinet_test
build_cu
